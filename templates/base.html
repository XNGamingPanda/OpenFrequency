<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenFrequency-ATC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Global Socket Init
        window.socket = io();
    </script>
</head>

<body class="bg-light text-dark">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">OpenFrequency-ATC</a>

            <div class="d-flex align-items-center">
                <select id="lang-selector" class="form-select form-select-sm" style="width: auto;">
                    <option value="en">English</option>
                    <option value="zh">ä¸­æ–‡</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="{% block container_class %}container mt-3{% endblock %}">
        {% block content %}{% endblock %}
    </div>

    <!-- Translations & Logic -->
    <script>
        const TRANSLATIONS = {
            "en": {
                "system_config": "System Configuration",
                "test_audio": "ðŸ”Š Test Audio",
                "pilot_profile": "Pilot Profile",
                "callsign": "Callsign",
                "simbrief_username": "SimBrief Username",
                "import": "Import",
                "simbrief_hint": "Enter username to fetch latest OFP.",
                "ai_connection": "AI Connection",
                "provider": "Provider",
                "api_key": "API Key",
                "api_key_hint": "Existing key is hidden. Leave as ****** to keep current.",
                "model_name": "Model Name",
                "base_url": "Base URL (Local/Ollama)",
                "audio_controls": "Audio & Controls",
                "joystick_ptt": "Joystick PTT",
                "unbound": "Unbound",
                "bind_btn": "Click to Bind Button",
                "radio_static": "Radio Static Effect",
                "traffic_density": "Traffic Density",
                "density_low": "Low (Lazy Afternoon)",
                "density_medium": "Medium (Standard)",
                "density_high": "High (Busy Hub)",
                "stt_model_path": "STT Model Path",
                "stt_language": "STT Language",
                "stt_auto": "Auto Detect",
                "save_settings": "Save Settings",
                "reload": "Reload",
                "back_dashboard": "Back to Dashboard",
                "settings_btn": "âš™ï¸ Settings",
                "altitude": "ALTITUDE",
                "airspeed": "AIRSPEED",
                "heading": "HEADING",
                "comms_log": "Comms Log",
                "connecting": "Connecting...",
                "connected_status": "Connected",
                "disconnected_status": "Disconnected",
                "send_btn": "Send",
                "type_message_placeholder": "Type your message...",
                "ptt_btn": "PUSH TO TALK",
                "security_settings": "Security & Access",
                "access_mode": "Access Mode",
                "security_hint": "Control who can access this dashboard via network.",
                "mode_doorbell": "ðŸŸ¡ Doorbell (Approve New)",
                "mode_open": "ðŸŸ¢ Open (Allow All)",
                "mode_lockdown": "ðŸ”´ Lockdown (Reject All)",
                "manage_devices_btn": "Manage Devices",
                "device_manager_title": "Device Management",
                "back_settings": "Back to Settings",
                "trusted_devices": "Trusted Devices",
                "banned_ips": "Blocked IPs",
                "device_info": "Device Info",
                "ip_address": "IP Address",
                "added_on": "Added On",
                "actions": "Actions",
                "revoke": "Revoke",
                "unban": "Unban",
                "preview_radar": "Preview Waiting Room",
                "session_devices": "Session Devices (Temporary)",
                "permissions": "Permissions",
                "perm_full": "Full Access",
                "perm_readonly": "Read Only",
                "readonly_notice": "Read-only mode - You can only view",
                "no_trusted_devices": "No trusted devices.",
                "no_session_devices": "No active session devices.",
                "no_banned_ips": "No banned IPs."
            },
            "zh": {
                "system_config": "ç³»ç»Ÿè®¾ç½®",
                "test_audio": "ðŸ”Š æµ‹è¯•éŸ³é¢‘",
                "pilot_profile": "é£žè¡Œå‘˜èµ„æ–™",
                "callsign": "å‘¼å·",
                "simbrief_username": "SimBrief ç”¨æˆ·å",
                "import": "å¯¼å…¥",
                "simbrief_hint": "è¾“å…¥ç”¨æˆ·åä»¥èŽ·å–æœ€æ–°é£žè¡Œè®¡åˆ’ã€‚",
                "ai_connection": "AI è¿žæŽ¥è®¾ç½®",
                "provider": "æœåŠ¡æä¾›å•†",
                "api_key": "API å¯†é’¥",
                "api_key_hint": "å¯†é’¥å·²éšè—ã€‚ä¿æŒ ****** ä¸å˜å³å¯ã€‚",
                "model_name": "æ¨¡åž‹åç§°",
                "base_url": "åŸºç¡€ URL (Local/Ollama)",
                "audio_controls": "éŸ³é¢‘ä¸ŽæŽ§åˆ¶",
                "joystick_ptt": "æ‘‡æ† PTT æŒ‰é”®",
                "unbound": "æœªç»‘å®š",
                "bind_btn": "ç‚¹å‡»ç»‘å®šæŒ‰é”®",
                "radio_static": "æ— çº¿ç”µæ‚éŸ³æ•ˆæžœ",
                "traffic_density": "äº¤é€šå¯†åº¦",
                "density_low": "ä½Ž (é—²é€‚åˆåŽ)",
                "density_medium": "ä¸­ (æ ‡å‡†)",
                "density_high": "é«˜ (ç¹å¿™æž¢çº½)",
                "stt_model_path": "STT æ¨¡åž‹è·¯å¾„",
                "stt_language": "è¯­éŸ³è¯†åˆ«è¯­è¨€",
                "stt_auto": "è‡ªåŠ¨è¯†åˆ«",
                "save_settings": "ä¿å­˜è®¾ç½®",
                "reload": "é‡æ–°åŠ è½½",
                "back_dashboard": "è¿”å›žä»ªè¡¨ç›˜",
                "settings_btn": "âš™ï¸ è®¾ç½®",
                "altitude": "é«˜åº¦ (ALT)",
                "airspeed": "ç©ºé€Ÿ (SPD)",
                "heading": "èˆªå‘ (HDG)",
                "comms_log": "é€šè®¯è®°å½•",
                "connecting": "è¿žæŽ¥ä¸­...",
                "connected_status": "å·²è¿žæŽ¥",
                "disconnected_status": "å·²æ–­å¼€",
                "send_btn": "å‘é€",
                "type_message_placeholder": "è¾“å…¥æ¶ˆæ¯...",
                "ptt_btn": "æŒ‰ä½é€šè¯ (PTT)",
                "security_settings": "å®‰å…¨ä¸Žè®¿é—®æŽ§åˆ¶",
                "access_mode": "è®¿é—®æ¨¡å¼",
                "security_hint": "æŽ§åˆ¶å…è®¸è°é€šè¿‡ç½‘ç»œè®¿é—®ä»ªè¡¨ç›˜ã€‚",
                "mode_doorbell": "ðŸŸ¡ é—¨é“ƒæ¨¡å¼ (éœ€æ‰¹å‡†)",
                "mode_open": "ðŸŸ¢ å¼€æ”¾æ¨¡å¼ (å…è®¸æ‰€æœ‰)",
                "mode_lockdown": "ðŸ”´ å°é”æ¨¡å¼ (æ‹’ç»æ‰€æœ‰)",
                "manage_devices_btn": "ç®¡ç†è®¾å¤‡",
                "device_manager_title": "è®¾å¤‡ç®¡ç†",
                "back_settings": "è¿”å›žè®¾ç½®",
                "trusted_devices": "å·²ä¿¡ä»»è®¾å¤‡",
                "banned_ips": "å·²å±è”½ IP",
                "device_info": "è®¾å¤‡ä¿¡æ¯",
                "ip_address": "IP åœ°å€",
                "added_on": "æ·»åŠ æ—¶é—´",
                "actions": "æ“ä½œ",
                "revoke": "æ’¤é”€æŽˆæƒ",
                "unban": "è§£å°",
                "preview_radar": "é¢„è§ˆç­‰å¾…å®¤ (é›·è¾¾)",
                "session_devices": "ä¸´æ—¶è®¾å¤‡ï¼ˆä»…æœ¬æ¬¡ä¼šè¯ï¼‰",
                "permissions": "æƒé™",
                "perm_full": "å®Œå…¨è®¿é—®",
                "perm_readonly": "ä»…æŸ¥çœ‹",
                "readonly_notice": "åªè¯»æ¨¡å¼ - ä»…å¯è§‚çœ‹",
                "no_trusted_devices": "æš‚æ— å·²ä¿¡ä»»è®¾å¤‡ã€‚",
                "no_session_devices": "æš‚æ— æ´»è·ƒçš„ä¸´æ—¶è®¾å¤‡ã€‚",
                "no_banned_ips": "æš‚æ— å·²å±è”½çš„ IPã€‚"
            }
        };


        function applyLanguage(lang) {
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang; // Accessibility

            const t = TRANSLATIONS[lang] || TRANSLATIONS['en'];

            // 1. Text Content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.innerText = t[key];
                }
            });

            // 2. Placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });

            // 3. Special Handling for PTT Button Logic (Dynamic)
            const pttBtn = document.getElementById('ptt-btn');
            if (pttBtn && !pttBtn.classList.contains('btn-danger')) {
                pttBtn.innerText = t['ptt_btn'];
            }
        }

        // Init
        const savedLang = localStorage.getItem('language') || 'en';
        document.getElementById('lang-selector').value = savedLang;
        applyLanguage(savedLang);

        // Event Listener
        document.getElementById('lang-selector').addEventListener('change', (e) => {
            applyLanguage(e.target.value);
        });

    </script>

    <!-- Admin Toasts (Hidden by default, shown via JS) -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container" style="z-index: 9999;">
        <!-- Toasts injected here -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>

    <script>
        // Admin Security Logic
        // Note: socket is defined in child templates usually, but checking here if it exists globally or re-using
        // Safer to check if socket exists or init a listener if we are on a page with socket.
        // Actually, let's assume socket is available if the page included it.
        // But base.html doesn't init socket. dashboard.html does.
        // We need this logic to run on dashboard.

        document.addEventListener('DOMContentLoaded', () => {
            if (window.socket) {
                // Handle force logout when access is revoked
                window.socket.on('force_logout', (data) => {
                    console.log("Access revoked, redirecting to waiting room...", data);
                    // Clear auth cookie
                    document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    // Redirect to waiting room
                    window.location.href = '/waiting_room';
                });

                // Handle permission change - force page refresh
                window.socket.on('permission_changed', (data) => {
                    console.log("Permission changed to:", data.permission);
                    // Force refresh to apply new permissions
                    window.location.reload();
                });

                window.socket.on('join_request', (data) => {
                    console.log("Admin: Join Request from", data);
                    const container = document.getElementById('toast-container');

                    const toastId = `toast-${data.sid}`;
                    const html = `
                        <div id="${toastId}" class="toast show text-white bg-dark" role="alert" aria-live="assertive" aria-atomic="true">
                          <div class="toast-header bg-secondary text-white">
                            <strong class="me-auto">ðŸ“¡ New Connection Request</strong>
                            <small>Just now</small>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                          </div>
                          <div class="toast-body">
                            <p class="mb-1"><strong>Device:</strong> ${data.device_name}</p>
                            <p class="mb-2 small text-muted">IP: ${data.ip}</p>
                            <div class="d-grid gap-2 d-md-block">
                              <button class="btn btn-sm btn-success w-100 mb-1" onclick="approveAuth('${data.sid}', 'trust')">Allow & Trust</button>
                               <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-light" onclick="approveAuth('${data.sid}', 'allow_once')">Once</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="denyAuth('${data.sid}', 'deny')">Deny</button>
                               </div>
                            </div>
                          </div>
                        </div>
                     `;

                    // Create element
                    const wrap = document.createElement('div');
                    wrap.innerHTML = html;
                    container.appendChild(wrap.firstElementChild);
                });
            }
        });

        window.approveAuth = function (sid, type) {
            socket.emit('admin_decision', { sid: sid, action: type });
            document.getElementById(`toast-${sid}`).remove();
        };

        window.denyAuth = function (sid, type) {
            socket.emit('admin_decision', { sid: sid, action: type });
            document.getElementById(`toast-${sid}`).remove();
        };
    </script>

    {% block scripts %}{% endblock %}
</body>

</html>
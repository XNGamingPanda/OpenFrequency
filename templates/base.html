<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenFrequency-ATC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Global Socket Init
        window.socket = io();
    </script>
    <style>
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a2e !important;
            color: #e0e0e0 !important;
        }

        body.dark-mode .navbar {
            background-color: #16213e !important;
            border-bottom-color: #0f3460 !important;
        }

        body.dark-mode .navbar-brand,
        body.dark-mode .nav-link {
            color: #e0e0e0 !important;
        }

        body.dark-mode .card {
            background-color: #16213e !important;
            border-color: #0f3460 !important;
            color: #e0e0e0 !important;
        }

        body.dark-mode .card-header {
            background-color: #0f3460 !important;
            border-color: #0f3460 !important;
        }

        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #16213e !important;
            border-color: #0f3460 !important;
            color: #e0e0e0 !important;
        }

        body.dark-mode .text-muted {
            color: #94a3b8 !important;
        }

        body.dark-mode .bg-light {
            background-color: #1a1a2e !important;
        }

        body.dark-mode .gauge-card {
            background-color: #0f3460 !important;
        }

        /* Dark Mode Comms Log Container */
        body.dark-mode #log-container {
            background-color: #1a1a2e !important;
        }

        body.dark-mode .card-footer {
            background-color: #16213e !important;
            border-color: #0f3460 !important;
        }

        /* Light Mode Gauge Card */
        body:not(.dark-mode) .gauge-card {
            background-color: #f1f5f9 !important;
        }
    </style>
</head>

<body class="bg-light text-dark">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">OpenFrequency-ATC</a>

            <div class="d-flex align-items-center">
                <select id="lang-selector" class="form-select form-select-sm" style="width: auto;">
                    <option value="en">English</option>
                    <option value="zh">‰∏≠Êñá</option>
                    <option value="ja">Êó•Êú¨Ë™û</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="{% block container_class %}container mt-3{% endblock %}">
        {% block content %}{% endblock %}
    </div>

    <!-- Translations & Logic -->
    <script>
        const TRANSLATIONS = {
            "en": {
                "system_config": "System Configuration",
                "test_audio": "üîä Test Audio",
                "pilot_profile": "Pilot Profile",
                "callsign": "Callsign",
                "simbrief_username": "SimBrief Username",
                "import": "Import",
                "simbrief_hint": "Enter username to fetch latest OFP.",
                "ai_connection": "AI Connection",
                "provider": "Provider",
                "api_key": "API Key",
                "api_key_hint": "Existing key is hidden. Leave as ****** to keep current.",
                "model_name": "Model Name",
                "base_url": "Base URL (Local/Ollama)",
                "audio_controls": "Audio & Controls",
                "joystick_ptt": "Joystick PTT",
                "unbound": "Unbound",
                "bind_btn": "Click to Bind Button",
                "radio_static": "Radio Static Effect",
                "traffic_density": "Traffic Density",
                "density_low": "Low (Lazy Afternoon)",
                "density_medium": "Medium (Standard)",
                "density_high": "High (Busy Hub)",
                "stt_model_path": "STT Model Path",
                "stt_language": "STT Language",
                "stt_auto": "Auto Detect",
                "save_settings": "Save Settings",
                "reload": "Reload",
                "back_dashboard": "Back to Dashboard",
                "settings_btn": "‚öôÔ∏è Settings",
                "altitude": "ALTITUDE",
                "airspeed": "AIRSPEED",
                "heading": "HEADING",
                "comms_log": "Comms Log",
                "connecting": "Connecting...",
                "connected_status": "Connected",
                "disconnected_status": "Disconnected",
                "send_btn": "Send",
                "type_message_placeholder": "Type your message...",
                "ptt_btn": "PUSH TO TALK",
                "security_settings": "Security & Access",
                "access_mode": "Access Mode",
                "security_hint": "Control who can access this dashboard via network.",
                "mode_doorbell": "üü° Doorbell (Approve New)",
                "mode_open": "üü¢ Open (Allow All)",
                "mode_lockdown": "üî¥ Lockdown (Reject All)",
                "manage_devices_btn": "Manage Devices",
                "device_manager_title": "Device Management",
                "back_settings": "Back to Settings",
                "trusted_devices": "Trusted Devices",
                "banned_ips": "Blocked IPs",
                "device_info": "Device Info",
                "ip_address": "IP Address",
                "added_on": "Added On",
                "actions": "Actions",
                "revoke": "Revoke",
                "unban": "Unban",
                "preview_radar": "Preview Waiting Room",
                "session_devices": "Session Devices (Temporary)",
                "permissions": "Permissions",
                "perm_full": "Full Access",
                "perm_readonly": "Read Only",
                "readonly_notice": "Read-only mode - You can only view",
                "no_trusted_devices": "No trusted devices.",
                "no_session_devices": "No active session devices.",
                "no_banned_ips": "No banned IPs.",
                "ui_settings": "üé® UI Settings",
                "dark_mode": "Dark Mode",
                "save_config": "Save Configuration",
                "tab_map": "Map",
                "tab_radar": "Radar (Traffic)",
                "career_btn": "üéñÔ∏è Career",
                "clear_track_btn": "üóëÔ∏è Clear",
                "cabin_status_btn": "üë©‚Äç‚úàÔ∏è Crew Status",
                "cabin_chat_btn": "üí¨ Cockpit Intercom",
                "radio_atc": "üì° ATC",
                "radio_crew": "üë• Crew",
                "first_officer": "First Officer",
                "purser": "Purser",
                "emergency_level": "Emergency Probability",
                "level_none": "None (Safe)",
                "level_low": "Low (Realistic)",
                "level_medium": "Medium (Frequent)",
                "level_high": "High (Mayday!)",
                "btn_boarding": "üõ´ Boarding",
                "btn_deboarding": "üõ¨ Deboarding",
                "btn_stop_sound": "üîá Stop Sound"
            },
            "zh": {
                "system_config": "Á≥ªÁªüËÆæÁΩÆ",
                "test_audio": "üîä ÊµãËØïÈü≥È¢ë",
                "pilot_profile": "È£ûË°åÂëòËµÑÊñô",
                "callsign": "ÂëºÂè∑",
                "simbrief_username": "SimBrief Áî®Êà∑Âêç",
                "import": "ÂØºÂÖ•",
                "simbrief_hint": "ËæìÂÖ•Áî®Êà∑Âêç‰ª•Ëé∑ÂèñÊúÄÊñ∞È£ûË°åËÆ°Âàí„ÄÇ",
                "ai_connection": "AI ËøûÊé•ËÆæÁΩÆ",
                "provider": "ÊúçÂä°Êèê‰æõÂïÜ",
                "api_key": "API ÂØÜÈí•",
                "api_key_hint": "ÂØÜÈí•Â∑≤ÈöêËóè„ÄÇ‰øùÊåÅ ****** ‰∏çÂèòÂç≥ÂèØ„ÄÇ",
                "model_name": "Ê®°ÂûãÂêçÁß∞",
                "base_url": "Âü∫Á°Ä URL (Local/Ollama)",
                "audio_controls": "Èü≥È¢ë‰∏éÊéßÂà∂",
                "joystick_ptt": "ÊëáÊùÜ PTT ÊåâÈîÆ",
                "unbound": "Êú™ÁªëÂÆö",
                "bind_btn": "ÁÇπÂáªÁªëÂÆöÊåâÈîÆ",
                "radio_static": "Êó†Á∫øÁîµÊùÇÈü≥ÊïàÊûú",
                "traffic_density": "‰∫§ÈÄöÂØÜÂ∫¶",
                "density_low": "‰Ωé (Èó≤ÈÄÇÂçàÂêé)",
                "density_medium": "‰∏≠ (Ê†áÂáÜ)",
                "density_high": "È´ò (ÁπÅÂøôÊû¢Á∫Ω)",
                "stt_model_path": "STT Ê®°ÂûãË∑ØÂæÑ",
                "stt_language": "ËØ≠Èü≥ËØÜÂà´ËØ≠Ë®Ä",
                "stt_auto": "Ëá™Âä®ËØÜÂà´",
                "save_settings": "‰øùÂ≠òËÆæÁΩÆ",
                "reload": "ÈáçÊñ∞Âä†ËΩΩ",
                "back_dashboard": "ËøîÂõû‰ª™Ë°®Áõò",
                "settings_btn": "‚öôÔ∏è ËÆæÁΩÆ",
                "altitude": "È´òÂ∫¶ (ALT)",
                "airspeed": "Á©∫ÈÄü (SPD)",
                "heading": "Ëà™Âêë (HDG)",
                "comms_log": "ÈÄöËÆØËÆ∞ÂΩï",
                "connecting": "ËøûÊé•‰∏≠...",
                "connected_status": "Â∑≤ËøûÊé•",
                "disconnected_status": "Â∑≤Êñ≠ÂºÄ",
                "send_btn": "ÂèëÈÄÅ",
                "type_message_placeholder": "ËæìÂÖ•Ê∂àÊÅØ...",
                "ptt_btn": "Êåâ‰ΩèÈÄöËØù (PTT)",
                "security_settings": "ÂÆâÂÖ®‰∏éËÆøÈóÆÊéßÂà∂",
                "access_mode": "ËÆøÈóÆÊ®°Âºè",
                "security_hint": "ÊéßÂà∂ÂÖÅËÆ∏Ë∞ÅÈÄöËøáÁΩëÁªúËÆøÈóÆ‰ª™Ë°®Áõò„ÄÇ",
                "mode_doorbell": "üü° Èó®ÈìÉÊ®°Âºè (ÈúÄÊâπÂáÜ)",
                "mode_open": "üü¢ ÂºÄÊîæÊ®°Âºè (ÂÖÅËÆ∏ÊâÄÊúâ)",
                "mode_lockdown": "üî¥ Â∞ÅÈîÅÊ®°Âºè (ÊãíÁªùÊâÄÊúâ)",
                "manage_devices_btn": "ÁÆ°ÁêÜËÆæÂ§á",
                "device_manager_title": "ËÆæÂ§áÁÆ°ÁêÜ",
                "back_settings": "ËøîÂõûËÆæÁΩÆ",
                "trusted_devices": "Â∑≤‰ø°‰ªªËÆæÂ§á",
                "banned_ips": "Â∑≤Â±èËîΩ IP",
                "device_info": "ËÆæÂ§á‰ø°ÊÅØ",
                "ip_address": "IP Âú∞ÂùÄ",
                "added_on": "Ê∑ªÂä†Êó∂Èó¥",
                "actions": "Êìç‰Ωú",
                "revoke": "Êí§ÈîÄÊéàÊùÉ",
                "unban": "Ëß£Â∞Å",
                "preview_radar": "È¢ÑËßàÁ≠âÂæÖÂÆ§ (Èõ∑Ëææ)",
                "session_devices": "‰∏¥Êó∂ËÆæÂ§áÔºà‰ªÖÊú¨Ê¨°‰ºöËØùÔºâ",
                "permissions": "ÊùÉÈôê",
                "perm_full": "ÂÆåÂÖ®ËÆøÈóÆ",
                "perm_readonly": "‰ªÖÊü•Áúã",
                "readonly_notice": "Âè™ËØªÊ®°Âºè - ‰ªÖÂèØËßÇÁúã",
                "no_trusted_devices": "ÊöÇÊó†Â∑≤‰ø°‰ªªËÆæÂ§á„ÄÇ",
                "no_session_devices": "ÊöÇÊó†Ê¥ªË∑ÉÁöÑ‰∏¥Êó∂ËÆæÂ§á„ÄÇ",
                "no_banned_ips": "ÊöÇÊó†Â∑≤Â±èËîΩÁöÑ IP„ÄÇ",
                "ui_settings": "üé® ÁïåÈù¢ËÆæÁΩÆ",
                "dark_mode": "Ê∑±Ëâ≤Ê®°Âºè",
                "save_config": "‰øùÂ≠òËÆæÁΩÆ",
                "tab_map": "Âú∞Âõæ",
                "tab_radar": "Èõ∑Ëææ (‰∫§ÈÄö)",
                "career_btn": "üéñÔ∏è ÁîüÊ∂ØÊ®°Âºè",
                "clear_track_btn": "üóëÔ∏è Ê∏ÖÈô§",
                "cabin_status_btn": "üë©‚Äç‚úàÔ∏è Êú∫ÁªÑÁä∂ÊÄÅ",
                "cabin_chat_btn": "üí¨ È©æÈ©∂Ëà±ÂØπËÆ≤",
                "radio_atc": "üì° ÁÆ°Âà∂",
                "radio_crew": "üë• Êú∫ÁªÑ",
                "first_officer": "ÂâØÈ©æÈ©∂",
                "purser": "‰πòÂä°Èïø",
                "emergency_level": "ÁâπÊÉÖÊ¶ÇÁéá",
                "level_none": "Êó† (ÂÆâÂÖ®)",
                "level_low": "‰Ωé (ÁúüÂÆû)",
                "level_medium": "‰∏≠ (È¢ëÁπÅ)",
                "level_high": "È´ò (Mayday!)",
                "btn_boarding": "üõ´ ÁôªÊú∫",
                "btn_deboarding": "üõ¨ ‰∏ãÊú∫",
                "btn_stop_sound": "üîá ÂÅúÊ≠¢Èü≥Êïà"
            },
            "ja": {
                "system_config": "„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö",
                "test_audio": "üîä Èü≥Â£∞„ÉÜ„Çπ„Éà",
                "pilot_profile": "„Éë„Ç§„É≠„ÉÉ„Éà„Éó„É≠„Éï„Ç£„Éº„É´",
                "callsign": "„Ç≥„Éº„É´„Çµ„Ç§„É≥",
                "simbrief_username": "SimBrief „É¶„Éº„Ç∂„ÉºÂêç",
                "import": "„Ç§„É≥„Éù„Éº„Éà",
                "simbrief_hint": "„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶OFP„ÇíÂèñÂæó",
                "ai_connection": "AIÊé•Á∂öË®≠ÂÆö",
                "provider": "„Éó„É≠„Éê„Ç§„ÉÄ„Éº",
                "api_key": "API„Ç≠„Éº",
                "api_key_hint": "Êó¢Â≠ò„ÅÆ„Ç≠„Éº„ÅØÈùûË°®Á§∫„Åß„Åô„ÄÇÂ§âÊõ¥„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ******„ÅÆ„Åæ„Åæ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                "model_name": "„É¢„Éá„É´Âêç",
                "base_url": "„Éô„Éº„ÇπURL („É≠„Éº„Ç´„É´/Ollama)",
                "audio_controls": "Èü≥Â£∞„ÉªÊìç‰ΩúË®≠ÂÆö",
                "joystick_ptt": "„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ PTT",
                "unbound": "Êú™Ë®≠ÂÆö",
                "bind_btn": "„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éú„Çø„É≥„ÇíÂâ≤„ÇäÂΩì„Å¶",
                "radio_static": "ÁÑ°Á∑ö„Éé„Ç§„Ç∫„Ç®„Éï„Çß„ÇØ„Éà",
                "traffic_density": "„Éà„É©„Éï„Ç£„ÉÉ„ÇØÂØÜÂ∫¶",
                "density_low": "‰ΩéÔºàÈùô„Åã„Å™ÂçàÂæåÔºâ",
                "density_medium": "‰∏≠ÔºàÊ®ôÊ∫ñÔºâ",
                "density_high": "È´òÔºàÁπÅÂøôÁ©∫Ê∏ØÔºâ",
                "stt_model_path": "STT „É¢„Éá„É´„Éë„Çπ",
                "stt_language": "Èü≥Â£∞Ë™çË≠òË®ÄË™û",
                "stt_auto": "Ëá™ÂãïÊ§úÂá∫",
                "save_settings": "Ë®≠ÂÆö„Çí‰øùÂ≠ò",
                "reload": "„É™„É≠„Éº„Éâ",
                "back_dashboard": "„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã",
                "settings_btn": "‚öôÔ∏è Ë®≠ÂÆö",
                "altitude": "È´òÂ∫¶ (ALT)",
                "airspeed": "ÂØæÊ∞óÈÄüÂ∫¶ (SPD)",
                "heading": "Ê©üÈ¶ñÊñπ‰Ωç (HDG)",
                "comms_log": "ÈÄö‰ø°„É≠„Ç∞",
                "connecting": "Êé•Á∂ö‰∏≠...",
                "connected_status": "Êé•Á∂öÊ∏à„Åø",
                "disconnected_status": "ÂàáÊñ≠",
                "send_btn": "ÈÄÅ‰ø°",
                "type_message_placeholder": "„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...",
                "ptt_btn": "„Éó„ÉÉ„Ç∑„É•„Éª„Éà„Ç•„Éª„Éà„Éº„ÇØ (PTT)",
                "security_settings": "„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö",
                "access_mode": "„Ç¢„ÇØ„Çª„Çπ„É¢„Éº„Éâ",
                "security_hint": "„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁµåÁî±„Åß„ÅÆ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÇíË®≠ÂÆö",
                "mode_doorbell": "üü° „Éâ„Ç¢„Éô„É´ÔºàÊâøË™çÂà∂Ôºâ",
                "mode_open": "üü¢ „Ç™„Éº„Éó„É≥ÔºàÂÖ®Âì°Ë®±ÂèØÔºâ",
                "mode_lockdown": "üî¥ „É≠„ÉÉ„ÇØ„ÉÄ„Ç¶„É≥ÔºàÂÖ®Âì°ÊãíÂê¶Ôºâ",
                "manage_devices_btn": "„Éá„Éê„Ç§„ÇπÁÆ°ÁêÜ",
                "device_manager_title": "„Éá„Éê„Ç§„ÇπÁÆ°ÁêÜ",
                "back_settings": "Ë®≠ÂÆö„Å´Êàª„Çã",
                "trusted_devices": "‰ø°È†ºÊ∏à„Åø„Éá„Éê„Ç§„Çπ",
                "banned_ips": "„Éñ„É≠„ÉÉ„ÇØÊ∏à„ÅøIP",
                "device_info": "„Éá„Éê„Ç§„ÇπÊÉÖÂ†±",
                "ip_address": "IP„Ç¢„Éâ„É¨„Çπ",
                "added_on": "ËøΩÂä†Êó•ÊôÇ",
                "actions": "Êìç‰Ωú",
                "revoke": "Âèñ„ÇäÊ∂à„Åó",
                "unban": "Ëß£Èô§",
                "preview_radar": "ÂæÖÊ©üÂÆ§„Éó„É¨„Éì„É•„Éº",
                "session_devices": "„Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éê„Ç§„ÇπÔºà‰∏ÄÊôÇÁöÑÔºâ",
                "permissions": "Ê®©Èôê",
                "perm_full": "„Éï„É´„Ç¢„ÇØ„Çª„Çπ",
                "perm_readonly": "Ë™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®",
                "readonly_notice": "Ë™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®„É¢„Éº„Éâ - Èñ≤Ë¶ß„ÅÆ„ÅøÂèØËÉΩ",
                "no_trusted_devices": "‰ø°È†ºÊ∏à„Åø„Éá„Éê„Ç§„Çπ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
                "no_session_devices": "„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éê„Ç§„Çπ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
                "no_banned_ips": "„Éñ„É≠„ÉÉ„ÇØÊ∏à„ÅøIP„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ",
                "ui_settings": "üé® UIË®≠ÂÆö",
                "dark_mode": "„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ",
                "save_config": "Ë®≠ÂÆö„Çí‰øùÂ≠ò",
                "tab_map": "Âú∞Âõ≥",
                "tab_radar": "„É¨„Éº„ÉÄ„Éº (‰∫§ÈÄö)",
                "career_btn": "üéñÔ∏è „Ç≠„É£„É™„Ç¢",
                "clear_track_btn": "üóëÔ∏è „ÇØ„É™„Ç¢",
                "cabin_status_btn": "üë©‚Äç‚úàÔ∏è „ÇØ„É´„Éº„Çπ„ÉÜ„Éº„Çø„Çπ",
                "cabin_chat_btn": "üí¨ „Ç≥„ÉÉ„ÇØ„Éî„ÉÉ„Éà„Ç§„É≥„Çø„Éº„Ç≥„É†",
                "radio_atc": "üì° ATC",
                "radio_crew": "üë• „ÇØ„É´„Éº",
                "first_officer": "ÂâØÊìçÁ∏¶Â£´",
                "purser": "„ÉÅ„Éº„Éï„Éë„Éº„Çµ„Éº",
                "emergency_level": "Á∑äÊÄ•‰∫ãÊÖãÁô∫ÁîüÁéá",
                "level_none": "„Å™„Åó (ÂÆâÂÖ®)",
                "level_low": "‰Ωé („É™„Ç¢„É´)",
                "level_medium": "‰∏≠ (È†ªÁπÅ)",
                "level_high": "È´ò („É°„Éº„Éá„Éº!)",
                "btn_boarding": "üõ´ Êê≠‰πó",
                "btn_deboarding": "üõ¨ ÈôçÊ©ü",
                "btn_stop_sound": "üîá Èü≥ÂÅúÊ≠¢"
            }
        };


        function applyLanguage(lang) {
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang; // Accessibility

            const t = TRANSLATIONS[lang] || TRANSLATIONS['en'];

            // 1. Text Content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.innerText = t[key];
                }
            });

            // 2. Placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });

            // 3. Special Handling for PTT Button Logic (Dynamic)
            const pttBtn = document.getElementById('ptt-btn');
            if (pttBtn && !pttBtn.classList.contains('btn-danger')) {
                pttBtn.innerText = t['ptt_btn'];
            }
        }

        // Init
        const savedLang = localStorage.getItem('language') || 'en';
        document.getElementById('lang-selector').value = savedLang;
        applyLanguage(savedLang);

        // Event Listener
        document.getElementById('lang-selector').addEventListener('change', (e) => {
            applyLanguage(e.target.value);
        });

    </script>

    <!-- Admin Toasts (Hidden by default, shown via JS) -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container" style="z-index: 9999;">
        <!-- Toasts injected here -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>

    <script>
        // Admin Security Logic
        // Note: socket is defined in child templates usually, but checking here if it exists globally or re-using
        // Safer to check if socket exists or init a listener if we are on a page with socket.
        // Actually, let's assume socket is available if the page included it.
        // But base.html doesn't init socket. dashboard.html does.
        // We need this logic to run on dashboard.

        document.addEventListener('DOMContentLoaded', () => {
            if (window.socket) {
                // Handle force logout when access is revoked
                window.socket.on('force_logout', (data) => {
                    console.log("Access revoked, redirecting to waiting room...", data);
                    // Clear auth cookie
                    document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    // Redirect to waiting room
                    window.location.href = '/waiting_room';
                });

                // Handle permission change - force page refresh
                window.socket.on('permission_changed', (data) => {
                    console.log("Permission changed to:", data.permission);
                    // Force refresh to apply new permissions
                    window.location.reload();
                });

                window.socket.on('join_request', (data) => {
                    console.log("Admin: Join Request from", data);
                    const container = document.getElementById('toast-container');

                    const toastId = `toast-${data.sid}`;
                    const html = `
                        <div id="${toastId}" class="toast show text-white bg-dark" role="alert" aria-live="assertive" aria-atomic="true">
                          <div class="toast-header bg-secondary text-white">
                            <strong class="me-auto">üì° New Connection Request</strong>
                            <small>Just now</small>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                          </div>
                          <div class="toast-body">
                            <p class="mb-1"><strong>Device:</strong> ${data.device_name}</p>
                            <p class="mb-2 small text-muted">IP: ${data.ip}</p>
                            <div class="d-grid gap-2 d-md-block">
                              <button class="btn btn-sm btn-success w-100 mb-1" onclick="approveAuth('${data.sid}', 'trust')">Allow & Trust</button>
                               <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-light" onclick="approveAuth('${data.sid}', 'allow_once')">Once</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="denyAuth('${data.sid}', 'deny')">Deny</button>
                               </div>
                            </div>
                          </div>
                        </div>
                     `;

                    // Create element
                    const wrap = document.createElement('div');
                    wrap.innerHTML = html;
                    container.appendChild(wrap.firstElementChild);
                });
            }
        });

        window.approveAuth = function (sid, type) {
            socket.emit('admin_decision', { sid: sid, action: type });
            document.getElementById(`toast-${sid}`).remove();
        };

        window.denyAuth = function (sid, type) {
            socket.emit('admin_decision', { sid: sid, action: type });
            document.getElementById(`toast-${sid}`).remove();
        };

        // Toggle function for settings page
        window.toggleDarkMode = function (enabled) {
            document.body.classList.toggle('dark-mode', enabled);
            localStorage.setItem('dark_mode', enabled ? '1' : '0');
        };

        // Immediate dark mode from localStorage (prevents flash)
        if (localStorage.getItem('dark_mode') === '1') {
            document.body.classList.add('dark-mode');
        }

        // Setup socket listeners after a short delay to ensure socket is initialized
        function setupSocketListeners() {
            if (!window.socket) {
                // Retry after 100ms if socket not ready yet
                setTimeout(setupSocketListeners, 100);
                return;
            }

            console.log("Setting up socket listeners for toasts...");

            // Flight Report Toast notification
            window.socket.on('flight_report_ready', (data) => {
                console.log("Flight Report Ready:", data);
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toastId = `toast-flight-report-${Date.now()}`;
                const html = `
                    <div id="${toastId}" class="toast show text-white bg-info" role="alert" aria-live="assertive" aria-atomic="true">
                      <div class="toast-header bg-info text-white">
                        <strong class="me-auto">üéâ Ëà™Á®ãÁªìÊùü / Flight Complete</strong>
                        <small>Just now</small>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                      </div>
                      <div class="toast-body">
                        <p class="mb-2">${data.message || 'Flight report generated!'}</p>
                        <a href="${data.report_url || '#'}" target="_blank" class="btn btn-light btn-sm w-100">üìä View Report / Êü•ÁúãËØ¶Âçï</a>
                      </div>
                    </div>
                `;
                const wrap = document.createElement('div');
                wrap.innerHTML = html;
                container.appendChild(wrap.firstElementChild);

                // Auto-dismiss after 15 seconds
                setTimeout(() => {
                    const toastEl = document.getElementById(toastId);
                    if (toastEl) toastEl.remove();
                }, 15000);
            });

            // Dark Mode sync from server config
            window.socket.on('config_sync', (cfg) => {
                const darkMode = cfg?.ui?.dark_mode || false;
                document.body.classList.toggle('dark-mode', darkMode);
                localStorage.setItem('dark_mode', darkMode ? '1' : '0');
            });
        }

        // Start socket listener setup after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(setupSocketListeners, 200);
        });
    </script>

    {% block scripts %}{% endblock %}
</body>

</html>
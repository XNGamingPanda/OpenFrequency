{% extends "base.html" %}

{% block container_class %}container-fluid p-3 h-100{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Header Row (Full Width) -->
    <div class="col-12 mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <!-- Status or other info could go here -->
            </div>
            <div>
                {% if can_interact %}
                <a href="/settings" class="btn btn-outline-secondary btn-sm" data-i18n="settings_btn">⚙️ Settings</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Left Column: Gauges + Map -->
    <div class="col-lg-7 d-flex flex-column h-100">
        <!-- Gauges -->
        <div class="row text-center mb-3">
            <div class="col-4">
                <div class="card shadow-sm">
                    <div class="card-body py-2">
                        <small class="text-muted" data-i18n="altitude">ALTITUDE</small>
                        <h4 id="data-altitude" class="card-title mb-0">0 FT</h4>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card shadow-sm">
                    <div class="card-body py-2">
                        <small class="text-muted" data-i18n="airspeed">AIRSPEED</small>
                        <h4 id="data-airspeed" class="card-title mb-0">0 KTS</h4>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card shadow-sm">
                    <div class="card-body py-2">
                        <small class="text-muted" data-i18n="heading">HEADING</small>
                        <h4 id="data-heading" class="card-title mb-0">0°</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div id="map" class="flex-grow-1 rounded shadow-sm mb-3"
            style="min-height: 400px; height: calc(100vh - 250px);"></div>
    </div>

    <!-- Right Column: Chat + PTT -->
    <div class="col-lg-5 d-flex flex-column h-100 ps-lg-4">
        <div class="card flex-grow-1 shadow-sm mb-3" style="min-height: 200px;">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-2">
                <strong data-i18n="comms_log">Comms Log</strong>
                <div>
                    <span id="status-badge" class="badge bg-secondary" data-i18n="connecting">Connecting...</span>
                </div>
            </div>
            <div class="card-body p-2" id="log-container"
                style="overflow-y: auto; max-height: calc(100vh - 300px); background-color: #f8f9fa;">
                <!-- Chat messages go here -->
            </div>
            {% if can_interact %}
            <div class="card-footer bg-white p-2">
                <div class="input-group">
                    <input type="text" id="text-input" class="form-control" placeholder="Type your message..."
                        aria-label="Type your message" data-i18n-placeholder="type_message_placeholder">
                    <button class="btn btn-outline-primary" type="button" id="btn-send-text"
                        data-i18n="send_btn">Send</button>
                </div>
            </div>
            {% else %}
            <div class="card-footer bg-light p-2 text-center text-muted">
                <small data-i18n="readonly_notice">Read-only mode - You can only view</small>
            </div>
            {% endif %}
        </div>

        {% if can_interact %}
        <button id="ptt-btn" class="btn btn-primary btn-lg w-100 py-3 fw-bold shadow-sm mb-3" data-i18n="ptt_btn">PUSH
            TO TALK</button>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // socket is defined in base.html as window.socket
    const socket = window.socket;

    const logContainer = document.getElementById('log-container');
    const altitudeEl = document.getElementById('data-altitude');
    const airspeedEl = document.getElementById('data-airspeed');
    const headingEl = document.getElementById('data-heading');

    const pttBtn = document.getElementById('ptt-btn');
    const textInput = document.getElementById('text-input');
    const btnSendText = document.getElementById('btn-send-text');

    // --- Text Input Logic ---
    function sendText() {
        if (!textInput) return;
        const text = textInput.value.trim();
        if (text) {
            socket.emit('text_input', text);
            textInput.value = '';
        }
    }

    if (btnSendText) {
        btnSendText.addEventListener('click', sendText);
    }
    if (textInput) {
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { sendText(); }
        });
    }

    // --- Gamepad PTT Logic (Read Only) ---
    // Dashboard just reads the binding from localStorage
    let gamepadIndex = -1;
    let pttButtonIndex = -1;
    let wasPressed = false;

    function loadPTTBinding() {
        const saved = localStorage.getItem('ptt_binding');
        if (saved) {
            const b = JSON.parse(saved);
            gamepadIndex = b.gp;
            pttButtonIndex = b.btn;
            console.log("PTT Bound to GP:", gamepadIndex, "BTN:", pttButtonIndex);
        }
    }

    function gamepadLoop() {
        const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
        if (!gamepads) return;

        for (let i = 0; i < gamepads.length; i++) {
            // Only listen to the bound gamepad
            if (i === gamepadIndex && pttButtonIndex !== -1) {
                const gp = gamepads[i];
                if (gp && gp.buttons[pttButtonIndex]) {
                    const isPressed = gp.buttons[pttButtonIndex].pressed;
                    if (isPressed && !wasPressed) startRecording();
                    else if (!isPressed && wasPressed) stopRecording();
                    wasPressed = isPressed;
                }
            }
        }
        requestAnimationFrame(gamepadLoop);
    }

    window.addEventListener("gamepadconnected", gamepadLoop);
    loadPTTBinding(); // Load immediately
    requestAnimationFrame(gamepadLoop);

    // --- Map Setup ---
    let map = L.map('map').setView([40.08, 116.58], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);
    let aircraftMarker;
    const flightPathNodes = [];
    const flightPathPolyline = L.polyline([], { color: 'red', weight: 3 }).addTo(map);

    socket.on('telemetry_update', (data) => {
        if (altitudeEl) altitudeEl.innerText = Math.round(data.altitude || 0);
        if (airspeedEl) airspeedEl.innerText = Math.round(data.airspeed || 0);
        if (headingEl) headingEl.innerText = Math.round(data.heading || 0);

        if (data.latitude && data.longitude) {
            const latLng = [data.latitude, data.longitude];
            if (!aircraftMarker) {
                aircraftMarker = L.marker(latLng).addTo(map);
                map.setView(latLng, 13);
            } else {
                aircraftMarker.setLatLng(latLng);
            }
            // Flight path logic...
            if (flightPathNodes.length === 0 || map.distance(flightPathNodes[flightPathNodes.length - 1], latLng) > 50) {
                flightPathNodes.push(latLng);
                flightPathPolyline.setLatLngs(flightPathNodes);
            }
        }
    });

    // --- Audio & socket logic same as before ---
    let mediaRecorder;
    let audioChunks = [];

    socket.on('connect', () => {
        const el = document.getElementById('status-badge');
        el.className = 'badge bg-success';

        // i18n dynamic text update
        const lang = localStorage.getItem('language') || 'en';
        el.innerText = (lang === 'zh') ? "已连接" : "Connected";
        el.setAttribute('data-i18n', 'connected_status');
    });

    socket.on('disconnect', () => {
        const el = document.getElementById('status-badge');
        el.className = 'badge bg-danger';
        const lang = localStorage.getItem('language') || 'en';
        el.innerText = (lang === 'zh') ? "已断开" : "Disconnected";
        el.setAttribute('data-i18n', 'disconnected_status');
    });

    socket.on('chat_log', (data) => {
        const div = document.createElement('div');
        div.className = `mb-2 p-2 rounded ${data.sender === 'Pilot' ? 'bg-primary text-white text-end' : 'bg-success text-white text-start'}`;
        div.innerHTML = `<strong>${data.sender}:</strong> ${data.text}`;
        logContainer.appendChild(div);
        logContainer.scrollTop = logContainer.scrollHeight;
    });

    // Audio Playback
    socket.on('audio_stream', (data) => {
        try {
            const audioData = atob(data.data);
            const audioBytes = new Uint8Array(audioData.length);
            for (let i = 0; i < audioData.length; i++) {
                audioBytes[i] = audioData.charCodeAt(i);
            }
            const audioBlob = new Blob([audioBytes], { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(audioBlob);
            new Audio(audioUrl).play().catch(e => console.error(e));
        } catch (e) { console.error(e); }
    });

    // PTT Recording
    const startRecording = () => {
        if (!pttBtn) return; // No PTT for readonly users
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            audioChunks = [];
            mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
            mediaRecorder.addEventListener("stop", () => socket.emit('voice_data', new Blob(audioChunks)));

            pttBtn.classList.remove('btn-primary');
            pttBtn.classList.add('btn-danger');

            const lang = localStorage.getItem('language') || 'en';
            pttBtn.innerText = (lang === 'zh') ? "正在传输..." : "TRANSMITTING...";
        });
    };

    const stopRecording = () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            if (pttBtn) {
                pttBtn.classList.add('btn-primary');
                pttBtn.classList.remove('btn-danger');

                const lang = localStorage.getItem('language') || 'en';
                pttBtn.innerText = (lang === 'zh') ? "按住通话 (PTT)" : "PUSH TO TALK";
            }
        }
    };

    // Events
    document.body.addEventListener('click', () => { new Audio(); }, { once: true });

    if (pttBtn) {
        pttBtn.addEventListener('mousedown', startRecording);
        pttBtn.addEventListener('mouseup', stopRecording);
        pttBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
        pttBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });
    }

    document.addEventListener('keydown', (e) => {
        if (document.activeElement.tagName === 'INPUT') return;
        if (e.code === 'Space' && !e.repeat && pttBtn) { e.preventDefault(); startRecording(); }
    });
    document.addEventListener('keyup', (e) => {
        if (document.activeElement.tagName === 'INPUT') return;
        if (e.code === 'Space' && pttBtn) { e.preventDefault(); stopRecording(); }
    });

</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}ç”Ÿæ¶¯æ¨¡å¼ - OpenFrequency{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-primary mb-0">
                <i class="bi bi-trophy-fill me-2"></i>ç”Ÿæ¶¯æ¨¡å¼ / Career Mode
            </h2>
            <p class="text-muted">è¿½è¸ªæ‚¨çš„é£è¡Œè¿›åº¦ï¼Œèµšå–ç»éªŒå’Œå¥–åŠ±</p>
        </div>
    </div>

    <!-- ä¸»è¦ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-white-50">ç­‰çº§ / Rank</h6>
                            <h4 class="card-title mb-0" id="profileRank">åŠ è½½ä¸­...</h4>
                        </div>
                        <i class="bi bi-award-fill fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-white-50">ç»éªŒå€¼ / XP</h6>
                            <h4 class="card-title mb-0" id="profileXP">0</h4>
                        </div>
                        <i class="bi bi-lightning-fill fs-1 opacity-50"></i>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-light" id="xpProgress" style="width: 0%"></div>
                    </div>
                    <small class="text-white-50" id="xpNextRank">ä¸‹ä¸€ç­‰çº§: --</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-warning text-dark h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-dark-50">ä½™é¢ / Money</h6>
                            <h4 class="card-title mb-0">$<span id="profileMoney">0</span></h4>
                        </div>
                        <i class="bi bi-coin fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1 text-white-50">é£è¡Œæ—¶é—´</h6>
                            <h4 class="card-title mb-0"><span id="profileFlightTime">0</span>h</h4>
                        </div>
                        <i class="bi bi-clock-fill fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‘¼å·è®¾ç½® -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-person-badge me-2"></i>é£è¡Œå‘˜èµ„æ–™
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">å‘¼å· / Callsign</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="callsignInput" placeholder="CCA988">
                            <button class="btn btn-primary" id="saveCallsignBtn">ä¿å­˜</button>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 id="profileFlights">0</h5>
                            <small class="text-muted">èˆªç­æ•°</small>
                        </div>
                        <div class="col-4">
                            <h5 id="profileLandings">0</h5>
                            <small class="text-muted">ç€é™†æ•°</small>
                        </div>
                        <div class="col-4">
                            <h5 id="profileBestLanding">--</h5>
                            <small class="text-muted">æœ€ä½³ç€é™†</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-card-checklist me-2"></i>æ‰§ç…§ / Licenses
                </div>
                <div class="card-body">
                    <div id="licensesList" class="d-flex flex-wrap gap-2">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿è§„è®°å½• -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-exclamation-triangle me-2"></i>è¿è§„è®°å½• / Violations</span>
                    <span class="badge bg-danger" id="violationCount">0</span>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>ç±»å‹</th>
                                <th>è¯¦æƒ…</th>
                            </tr>
                        </thead>
                        <tbody id="violationsTable">
                            <tr>
                                <td colspan="3" class="text-muted text-center">æš‚æ— è¿è§„è®°å½•</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .bg-gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const socket = io();

        // åŠ è½½æ¡£æ¡ˆ
        function loadProfile() {
            fetch('/career/profile')
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        console.error('Career profile error:', data.error);
                        return;
                    }
                    updateUI(data);
                })
                .catch(e => console.error('Failed to load profile:', e));
        }

        function updateUI(profile) {
            document.getElementById('profileRank').textContent = profile.rank || 'Unknown';
            document.getElementById('profileXP').textContent = profile.xp || 0;
            document.getElementById('profileMoney').textContent = profile.money || 0;
            document.getElementById('profileFlightTime').textContent = (profile.total_flight_time || 0).toFixed(1);
            document.getElementById('profileFlights').textContent = profile.flights_completed || 0;
            document.getElementById('profileLandings').textContent = profile.landings || 0;
            document.getElementById('callsignInput').value = profile.callsign || '';

            if (profile.best_landing_g) {
                document.getElementById('profileBestLanding').textContent = profile.best_landing_g.toFixed(2) + 'G';
            }

            // æ‰§ç…§åˆ—è¡¨
            const licList = document.getElementById('licensesList');
            licList.innerHTML = '';
            (profile.licenses || []).forEach(lic => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary fs-6';
                badge.textContent = lic;
                licList.appendChild(badge);
            });

            // è¿è§„è®°å½•
            const violations = profile.violations || [];
            document.getElementById('violationCount').textContent = violations.length;
            const tbody = document.getElementById('violationsTable');
            if (violations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">æš‚æ— è¿è§„è®°å½• âœ“</td></tr>';
            } else {
                tbody.innerHTML = violations.slice(-10).reverse().map(v => `
                <tr>
                    <td>${new Date(v.timestamp).toLocaleString()}</td>
                    <td><span class="badge bg-warning text-dark">${v.type}</span></td>
                    <td>${v.details || '-'}</td>
                </tr>
            `).join('');
            }

            // XP è¿›åº¦æ¡
            fetch('/career/progress')
                .then(r => r.json())
                .then(prog => {
                    document.getElementById('xpProgress').style.width = (prog.progress * 100) + '%';
                    if (prog.next_rank) {
                        document.getElementById('xpNextRank').textContent = `ä¸‹ä¸€ç­‰çº§: ${prog.next_rank} (${prog.xp_needed} XP)`;
                    } else {
                        document.getElementById('xpNextRank').textContent = 'ğŸ† æœ€é«˜ç­‰çº§';
                    }
                });
        }

        // ä¿å­˜å‘¼å·
        document.getElementById('saveCallsignBtn').addEventListener('click', function () {
            const callsign = document.getElementById('callsignInput').value.trim().toUpperCase();
            if (!callsign) return;

            fetch('/career/callsign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ callsign: callsign })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    alert('å‘¼å·å·²æ›´æ–°: ' + callsign);
                    loadProfile();
                }
            });
        });

        // å®æ—¶äº‹ä»¶
        socket.on('career_event', function (data) {
            console.log('Career Event:', data);
            loadProfile();  // åˆ·æ–°

            // Toast é€šçŸ¥
            if (data.type === 'violation') {
                showToast(`âš ï¸ è¿è§„: ${data.violation} (-${data.xp_penalty} XP)`, 'warning');
            } else if (data.type === 'landing') {
                showToast(`ğŸ›¬ ç€é™†è¯„çº§: ${data.grade.toUpperCase()} (+${data.xp} XP)`, 'success');
            }
        });

        function showToast(message, type) {
            // ç®€æ˜“ Toast
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
            toast.style.zIndex = 9999;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        loadProfile();
    });
</script>
{% endblock %}
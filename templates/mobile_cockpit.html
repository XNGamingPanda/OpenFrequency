{% extends "base.html" %}

{% block content %}
<!-- Data Display -->
<div class="alert alert-primary py-1 text-center small">
    üì± Mobile Strict View - <a href="/?view=desktop">Switch to Desktop</a>
</div>
<div class="row text-center mb-3">
    <div class="col-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Altitude</h6>
                <h4 id="data-altitude" class="card-title text-dark">0 FT</h4>
            </div>
        </div>
    </div>
    <div class="col-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Airspeed</h6>
                <h4 id="data-airspeed" class="card-title text-dark">0 KTS</h4>
            </div>
        </div>
    </div>
    <div class="col-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Heading</h6>
                <h4 id="data-heading" class="card-title text-dark">0¬∞</h4>
            </div>
        </div>
    </div>
</div>

<div id="map" style="height: 400px; margin-bottom: 1rem;"></div>

<div class="row">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Comms Log</span>
                <span id="status-badge" class="badge bg-danger">Disconnected</span>
            </div>
            <div class="card-body" id="log-container"
                style="height: 50vh; overflow-y: auto; background-color: #f8f9fa;">
                <!-- ËÅäÂ§©ËÆ∞ÂΩï -->
            </div>
            {% if can_interact %}
            <div class="card-footer d-flex justify-content-between">
                <a href="/?view=desktop" class="btn btn-sm btn-outline-secondary">üíª Desktop View</a>
                <button class="btn btn-sm btn-outline-secondary" onclick="testAudio()">üîä Test Audio</button>
            </div>
            {% else %}
            <div class="card-footer bg-light text-center text-muted">
                <small data-i18n="readonly_notice">Read-only mode - You can only view</small>
            </div>
            {% endif %}
        </div>
        {% if can_interact %}
        <button id="ptt-btn" class="btn btn-primary btn-lg w-100 py-4 fw-bold">PUSH TO TALK</button>
        {% endif %}
    </div>
</div>
</div>

<!-- Cabin Intercom Button -->
<div class="row mb-3">
    <div class="col-12">
        <button type="button" class="btn btn-info w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#cabinModal">
            üë©‚Äç‚úàÔ∏è CABIN INTERCOM
        </button>
    </div>
</div>

<!-- Cabin Modal -->
<div class="modal fade" id="cabinModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cabin Intercom</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-grid gap-2">
                <button class="btn btn-outline-primary p-3" onclick="callPurser('call_purser')">
                    üîî Call Purser
                </button>
                <button class="btn btn-outline-success p-3" onclick="callPurser('prepare_cabin')">
                    üõ´ Prepare Cabin (Gate/Takeoff)
                </button>
                <button class="btn btn-outline-danger p-3" onclick="callPurser('emergency')">
                    ‚ö†Ô∏è EMERGENCY (Brace)
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Reuse global socket from base.html to prevent double connection
    const socket = window.socket || io();

    const logContainer = document.getElementById('log-container');
    const altitudeEl = document.getElementById('data-altitude');
    const airspeedEl = document.getElementById('data-airspeed');
    const headingEl = document.getElementById('data-heading');
    const pttBtn = document.getElementById('ptt-btn');

    function testAudio() {
        console.log("Requesting Test Audio...");
        socket.emit('test_tts_trigger');
    }

    function callPurser(action) {
        console.log("Calling Purser:", action);
        socket.emit('cabin_intercom', { action: action });
        // Close modal
        const modalEl = document.getElementById('cabinModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
    }

    // Force audio context unlock on first interaction
    document.body.addEventListener('click', () => { const a = new Audio(); }, { once: true });

    let map = L.map('map').setView([40.08, 116.58], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);
    let aircraftMarker;

    let mediaRecorder;
    let audioChunks = [];

    // --- SocketIO Event Handlers ---

    socket.on('connect', () => {
        const el = document.getElementById('status-badge');
        el.className = 'badge bg-warning'; // Warning until sim connects
        el.innerText = 'Server Connected';
    });

    socket.on('disconnect', () => {
        const el = document.getElementById('status-badge');
        el.className = 'badge bg-danger';
        el.innerText = 'Disconnected';
    });

    socket.on('sim_status', (data) => {
        const el = document.getElementById('status-badge');
        if (data.connected) {
            el.className = 'badge bg-success';
            el.innerText = 'Sim Connected';
        } else {
            el.className = 'badge bg-secondary';
            el.innerText = 'Searching Sim...';
        }
    });

    // Request initial status
    socket.emit('request_sim_status');

    socket.on('chat_log', (data) => {
        // ÁÆ°Âà∂ËßíËâ≤È¢úËâ≤Êò†Â∞Ñ
        const roleColorMap = {
            'Ground': '#8B4513', 'Tower': '#28a745', 'Departure': '#007bff',
            'Center': '#6f42c1', 'Approach': '#fd7e14', 'Emergency': '#dc3545',
            'ATIS': '#6c757d', 'Cabin': '#e83e8c', 'SYSTEM': '#343a40', 'Pilot': '#17a2b8'
        };
        let bgColor = '#28a745';
        for (const role in roleColorMap) {
            if (data.sender.includes(role)) { bgColor = roleColorMap[role]; break; }
        }
        const div = document.createElement('div');
        div.className = `mb-2 p-2 rounded ${data.sender === 'Pilot' ? 'text-end' : 'text-start'}`;
        div.style.cssText = `background-color: ${bgColor}; color: white;`;
        div.innerHTML = `<strong>${data.sender}:</strong> ${data.text}`;
        logContainer.appendChild(div);
        logContainer.scrollTop = logContainer.scrollHeight;
    });

    socket.on('telemetry_update', (data) => {
        if (data) {
            altitudeEl.innerText = `${Math.round(data.altitude || 0)} FT`;
            airspeedEl.innerText = `${Math.round(data.airspeed || 0)} KTS`;
            headingEl.innerText = `${Math.round(data.heading || 0)}¬∞`;

            if (data.latitude && data.longitude) {
                const latLng = [data.latitude, data.longitude];
                if (!aircraftMarker) {
                    aircraftMarker = L.marker(latLng, {
                        icon: L.divIcon({
                            className: 'aircraft-icon',
                            html: '‚úàÔ∏è',
                            iconSize: [24, 24]
                        })
                    }).addTo(map);
                    map.setView(latLng, 13);
                } else {
                    aircraftMarker.setLatLng(latLng);
                }
                if (aircraftMarker.setRotationAngle) aircraftMarker.setRotationAngle(data.heading || 0);
                map.panTo(latLng);
            }
        }
    });

    socket.on('audio_stream', (data) => {
        console.log("Received audio stream chunk, size:", data.data.length);
        try {
            const audioData = atob(data.data);
            const audioBytes = new Uint8Array(audioData.length);
            for (let i = 0; i < audioData.length; i++) {
                audioBytes[i] = audioData.charCodeAt(i);
            }
            const audioBlob = new Blob([audioBytes], { type: 'audio/mpeg' });
            console.log("Blob created:", audioBlob);

            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);

            audio.play()
                .then(() => console.log("Audio playing successfully."))
                .catch(e => {
                    console.error("Audio playback interrupted/failed:", e);
                    // alert("Audio playback blocked? Click page to unmute.");
                });
        } catch (e) {
            console.error("Error processing audio data:", e);
        }
    });

    // ... (PTT Logic) ...

    const startRecording = () => {
        if (!pttBtn) return; // No PTT for readonly users
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];

                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks);
                    socket.emit('voice_data', audioBlob);
                });

                pttBtn.classList.remove('btn-primary');
                pttBtn.classList.add('btn-danger');
                pttBtn.innerText = "TRANSMITTING...";
            });
    };

    const stopRecording = () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            if (pttBtn) {
                pttBtn.classList.add('btn-primary');
                pttBtn.classList.remove('btn-danger');
                pttBtn.innerText = "PUSH TO TALK";
            }
        }
    };

    if (pttBtn) {
        pttBtn.addEventListener('mousedown', startRecording);
        pttBtn.addEventListener('mouseup', stopRecording);
        pttBtn.addEventListener('touchstart', startRecording);
        pttBtn.addEventListener('touchend', stopRecording);
    }

</script>
{% endblock %}
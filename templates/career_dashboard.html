{% extends "base.html" %}
{% block content %}

<style>
    .career-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        padding: 20px;
    }

    .career-card {
        background: var(--card-bg-color, #fff);
        border-radius: 16px;
        padding: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .career-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        border-color: var(--main-accent-color, #3b82f6);
    }

    .career-card h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .career-card .icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .career-header {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        color: white;
        padding: 30px;
        border-radius: 0 0 20px 20px;
    }

    .stat-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .job-list,
    .license-list,
    .transaction-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .job-item {
        background: var(--card-bg-color, #f8f9fa);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid #3b82f6;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .job-item:hover {
        background: rgba(59, 130, 246, 0.1);
    }

    .license-item {
        background: var(--card-bg-color, #f8f9fa);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid #10b981;
    }

    .license-item.owned {
        border-left-color: #f59e0b;
        opacity: 0.7;
    }

    .transaction-item {
        padding: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .transaction-item.income {
        border-left: 3px solid #10b981;
    }

    .transaction-item.expense {
        border-left: 3px solid #ef4444;
    }

    .callsign-locked {
        background: #fef3c7;
        border: 2px dashed #f59e0b;
        padding: 12px;
        border-radius: 8px;
    }

    .back-btn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 100;
    }
</style>

<!-- Career Header -->
<div class="career-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="mb-1">üéñÔ∏è <span data-i18n="career_dashboard">Career Dashboard</span></h1>
            <p class="mb-0 opacity-75">
                <span id="pilot-rank">Student (P0)</span> -
                <span id="pilot-callsign" class="fw-bold">STUDENT01</span>
            </p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <span class="stat-badge">üí∞ $<span id="balance">5000</span></span>
            <span class="stat-badge">‚≠ê <span id="xp">0</span> XP</span>
            <span class="stat-badge">üïê <span id="flight-hours">0</span>h</span>
        </div>
    </div>
</div>

<!-- Career Grid -->
<div class="career-grid">
    <!-- 1. Job Market -->
    <div class="career-card" onclick="openJobMarket()">
        <div class="icon">üìã</div>
        <h3 data-i18n="btn_job_market">Job Market</h3>
        <p class="text-muted mb-0">
            <span data-i18n="job_available">Available:</span> <span id="job-count" class="fw-bold text-primary">5</span>
            <span data-i18n="job_available">jobs</span>
        </p>
    </div>

    <!-- 2. License Center -->
    <div class="career-card" onclick="openLicenseCenter()">
        <div class="icon">üéì</div>
        <h3 data-i18n="btn_license">License Center</h3>
        <p class="text-muted mb-0">
            <span data-i18n="lbl_rank">Current:</span> <span id="current-license" class="fw-bold">P0</span>
        </p>
    </div>

    <!-- 3. Bank / Finance -->
    <div class="career-card" onclick="openBank()">
        <div class="icon">üí∞</div>
        <h3 data-i18n="btn_bank">Bank Account</h3>
        <p class="text-muted mb-0">
            <span data-i18n="lbl_balance">Balance:</span> $<span id="bank-balance"
                class="fw-bold text-success">5000</span>
        </p>
    </div>

    <!-- 4. Violation History -->
    <div class="career-card" onclick="openViolations()">
        <div class="icon">‚ö†Ô∏è</div>
        <h3 data-i18n="violation_history">Violations</h3>
        <p class="text-muted mb-0">
            Clean Record: <span id="safe-hours" class="fw-bold text-success">12</span>h
        </p>
    </div>
</div>

<!-- Active Job Panel -->
<div class="container mt-4" id="active-job-panel" style="display: none;">
    <div class="card border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">‚úàÔ∏è Active Job</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Route:</strong> <span id="job-route">ZBAA ‚Üí ZSPD</span></p>
                    <p><strong>Aircraft:</strong> <span id="job-aircraft">B737</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Pay:</strong> $<span id="job-pay">3500</span></p>
                    <p><strong>XP Reward:</strong> <span id="job-xp">450</span></p>
                </div>
            </div>
            <div class="callsign-locked">
                üîí <strong>Callsign Locked:</strong> <span id="locked-callsign">B-5421</span>
            </div>
            <div class="mt-3">
                <a href="/dashboard?mode=career" class="btn btn-success">üõ´ Start Flight</a>
            </div>
        </div>
    </div>
</div>

<!-- Back to Main Menu -->
<a href="/" class="btn btn-outline-light back-btn">‚Üê <span data-i18n="back_dashboard">Back to Menu</span></a>

<!-- Job Market Modal -->
<div class="modal fade" id="jobMarketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìã <span data-i18n="btn_job_market">Job Market</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body job-list" id="job-list">
                <!-- Jobs will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- License Center Modal -->
<div class="modal fade" id="licenseCenterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üéì <span data-i18n="btn_license">License Center</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body license-list" id="license-list">
                <!-- Licenses will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Bank Modal -->
<div class="modal fade" id="bankModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üí∞ <span data-i18n="btn_bank">Bank Account</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success text-center">
                    <h3>$<span id="modal-bank-balance">5000</span></h3>
                    <small data-i18n="bank_balance">Account Balance</small>
                </div>
                <h6 data-i18n="bank_history">Transaction History</h6>
                <div class="transaction-list" id="transaction-list">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Violations Modal -->
<div class="modal fade" id="violationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö†Ô∏è <span data-i18n="violation_history">Violation History</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="violations-list">
                <div class="alert alert-success">
                    ‚úÖ No violations recorded. Keep flying safely!
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = window.socket || io();

    // i18n Translation loading
    function loadTranslations() {
        const lang = localStorage.getItem('language') || 'en';
        const localeMap = { 'en': 'en-US', 'zh': 'zh-CN', 'ja': 'ja-JP' };
        const locale = localeMap[lang] || 'en-US';

        fetch(`/api/locales/${locale}`)
            .then(r => r.json())
            .then(translations => {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[key]) {
                        el.textContent = translations[key];
                    }
                });
            })
            .catch(e => console.log('Translations error:', e));
    }

    // Load career profile
    function loadProfile() {
        fetch('/career/profile')
            .then(r => r.json())
            .then(data => {
                document.getElementById('pilot-rank').textContent = data.rank || 'Student (P0)';
                document.getElementById('pilot-callsign').textContent = data.callsign || 'STUDENT01';
                document.getElementById('balance').textContent = data.money || 0;
                document.getElementById('bank-balance').textContent = data.money || 0;
                document.getElementById('modal-bank-balance').textContent = data.money || 0;
                document.getElementById('xp').textContent = data.xp || 0;
                document.getElementById('flight-hours').textContent = Math.round(data.total_flight_time || 0);
                document.getElementById('current-license').textContent = data.licenses ? data.licenses[data.licenses.length - 1] : 'P0';

                // Check for active job
                if (data.active_job) {
                    showActiveJob(data.active_job);
                }
            });
    }

    function showActiveJob(job) {
        document.getElementById('active-job-panel').style.display = 'block';
        document.getElementById('job-route').textContent = `${job.origin} ‚Üí ${job.destination}`;
        document.getElementById('job-aircraft').textContent = job.aircraft;
        document.getElementById('job-pay').textContent = job.pay;
        document.getElementById('job-xp').textContent = job.xp_reward;
        document.getElementById('locked-callsign').textContent = job.callsign;

        // Lock callsign in UI
        document.getElementById('pilot-callsign').textContent = job.callsign;
    }

    function openJobMarket() {
        // Load jobs via API
        fetch('/career/jobs')
            .then(r => r.json())
            .then(jobs => {
                const list = document.getElementById('job-list');
                list.innerHTML = jobs.map(job => `
                    <div class="job-item" data-job-id="${job.id}">
                        <div class="d-flex justify-content-between">
                            <strong>${job.origin_name} ‚Üí ${job.destination_name}</strong>
                            <span class="badge bg-success">$${job.pay}</span>
                        </div>
                        <div class="small text-muted mt-1">
                            ‚úàÔ∏è ${job.aircraft} | üìè ${job.distance_km}km | ‚≠ê ${job.xp_reward} XP
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="small">üîñ Callsign: <strong>${job.callsign}</strong></span>
                            <button class="btn btn-sm btn-primary accept-job-btn" data-job-id="${job.id}">
                                ‚úÖ Accept
                            </button>
                        </div>
                    </div>
                `).join('');

                // Add event listeners for accept buttons
                list.querySelectorAll('.accept-job-btn').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        acceptJob(this.getAttribute('data-job-id'));
                    });
                });

                document.getElementById('job-count').textContent = jobs.length;
                new bootstrap.Modal(document.getElementById('jobMarketModal')).show();
            });
    }

    function acceptJob(jobId) {
        console.log('Accepting job:', jobId);
        fetch('/career/accept_job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: jobId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('jobMarketModal')).hide();
                    showActiveJob(data.job);
                    loadProfile();
                    alert('‚úÖ Job accepted! Your callsign is now: ' + data.callsign);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            })
            .catch(e => {
                console.error('Accept job error:', e);
                alert('‚ùå Network error');
            });
    }

    function openLicenseCenter() {
        fetch('/career/licenses')
            .then(r => r.json())
            .then(licenses => {
                const list = document.getElementById('license-list');
                list.innerHTML = licenses.map(lic => `
                    <div class="license-item ${lic.owned ? 'owned' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${lic.name}</strong>
                                ${lic.owned ? '<span class="badge bg-warning ms-2">‚úì Owned</span>' : ''}
                            </div>
                            <span class="badge bg-primary">$${lic.price}</span>
                        </div>
                        <div class="small text-muted mt-1">
                            üìä Requires: ${lic.required_xp} XP | ${lic.required_hours}h flight time
                        </div>
                        ${!lic.owned ? `
                            <button class="btn btn-sm ${lic.can_buy ? 'btn-success' : 'btn-secondary'} mt-2 buy-license-btn" 
                                    data-license-id="${lic.id}" ${!lic.can_buy ? 'disabled' : ''}>
                                ${lic.can_buy ? 'üéì Purchase License' : 'üîí Requirements Not Met'}
                            </button>
                        ` : ''}
                    </div>
                `).join('');

                // Add event listeners
                list.querySelectorAll('.buy-license-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        buyLicense(this.getAttribute('data-license-id'));
                    });
                });

                new bootstrap.Modal(document.getElementById('licenseCenterModal')).show();
            });
    }

    function buyLicense(licenseId) {
        if (!confirm('Are you sure you want to purchase this license?')) return;

        fetch('/career/buy_license', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ license_id: licenseId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('üéâ Congratulations! You earned your ' + licenseId + ' license!');
                    loadProfile();
                    openLicenseCenter(); // Refresh list
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            });
    }

    function openBank() {
        loadProfile();
        fetch('/career/transactions')
            .then(r => r.json())
            .then(transactions => {
                const list = document.getElementById('transaction-list');
                if (transactions.length === 0) {
                    list.innerHTML = '<div class="text-muted text-center py-3">No transactions yet</div>';
                } else {
                    list.innerHTML = transactions.map(tx => `
                        <div class="transaction-item ${tx.amount > 0 ? 'income' : 'expense'}">
                            <div class="d-flex justify-content-between">
                                <span>${tx.description}</span>
                                <strong class="${tx.amount > 0 ? 'text-success' : 'text-danger'}">
                                    ${tx.amount > 0 ? '+' : ''}$${tx.amount}
                                </strong>
                            </div>
                            <small class="text-muted">${tx.date || ''}</small>
                        </div>
                    `).join('');
                }
                new bootstrap.Modal(document.getElementById('bankModal')).show();
            });
    }

    function openViolations() {
        fetch('/career/profile')
            .then(r => r.json())
            .then(profile => {
                const list = document.getElementById('violations-list');
                const violations = profile.violations || [];
                if (violations.length === 0) {
                    list.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ No violations recorded. Keep flying safely!<br>
                            <small class="text-muted">Safe flight hours: ${Math.round(profile.total_flight_time || 0)}h</small>
                        </div>
                    `;
                } else {
                    list.innerHTML = violations.map(v => `
                        <div class="alert alert-warning">
                            ‚ö†Ô∏è <strong>${v.type}</strong> - ${v.description}<br>
                            <small class="text-muted">${v.date}</small>
                        </div>
                    `).join('');
                }
                new bootstrap.Modal(document.getElementById('violationsModal')).show();
            });
    }

    // Init
    loadProfile();
    loadTranslations();
</script>

{% endblock %}